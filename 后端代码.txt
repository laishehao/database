CREATE TABLE User (
    Uno int AUTO_INCREMENT PRIMARY KEY,
    Uname VARCHAR(50) NOT NULL,
    Upassword VARCHAR(100) NOT NULL,
    Uemail VARCHAR(100) NOT NULL UNIQUE,
    Urole VARCHAR(20),
    Ugender CHAR(1),
    Umajor VARCHAR(50),
    Uphone VARCHAR(20) NOT NULL UNIQUE,
    Uavatar VARCHAR(200)
);


CREATE TABLE Course (
    Cno int AUTO_INCREMENT PRIMARY KEY,
    Cname VARCHAR(100) NOT NULL,
    Cmajor VARCHAR(50),
    Ccredit INT,
    Ctype VARCHAR(20),
    Uno int,
    FOREIGN KEY (Uno) REFERENCES User(Uno) ON DELETE SET NULL
);


CREATE TABLE Work (
    Wno int AUTO_INCREMENT PRIMARY KEY,
    Wtitle VARCHAR(200) NOT NULL,
    Cno int,
    Wprogress INT DEFAULT 0,
    Wstart DATETIME,
    Wover DATETIME,
    FOREIGN KEY (Cno) REFERENCES Course(Cno) ON DELETE CASCADE
);

CREATE TABLE `Write` (
    Wno int NOT NULL,
    Uno int NOT NULL,
    State INT DEFAULT 0,
    PRIMARY KEY (Wno, Uno),
    FOREIGN KEY (Wno) REFERENCES Work(Wno) ON DELETE CASCADE,
    FOREIGN KEY (Uno) REFERENCES `User`(Uno) ON DELETE CASCADE
);


DELIMITER $$
CREATE PROCEDURE Register(
    IN p_name INT,
    IN p_phone VARCHAR(50),
    IN p_password VARCHAR(100),
    IN p_email VARCHAR(100),
    IN p_role VARCHAR(20)
)
BEGIN
    DECLARE EXIT HANDLER FOR 1062  
    BEGIN
        ROLLBACK;
        
        IF EXISTS (SELECT 1 FROM `User` WHERE Uphone = p_phone) THEN
            SELECT 'ERROR:PHONE_EXISTS' AS result_type, NULL AS user_id, NULL AS user_role;
        ELSE
            SELECT 'ERROR:EMAIL_EXISTS' AS result_type, NULL AS user_id, NULL AS user_role;
        END IF;
    END;
    
    DECLARE EXIT HANDLER FOR SQLEXCEPTION
    BEGIN
        ROLLBACK;
        SELECT 'ERROR:SYSTEM_ERROR' AS result_type, NULL AS user_id, NULL AS user_role;
    END;
    
    START TRANSACTION;
    
   
    INSERT INTO `User` (
        Uname, Upassword, Uemail, Urole,Uphone
    ) VALUES (
        p_name, SHA2(p_password, 256), 
        p_email, p_role,p_phone
    );
    
    COMMIT;
    SELECT 'SUCCESS' AS result_type, p_id AS user_id, p_role AS user_role;
END
$$
DELIMITER ;